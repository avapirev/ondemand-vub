#!/bin/bash

# This runs inside the network namespace
# We can use any port we like

bin/authrevproxy.py \
  --app-port=8080 \
  --proxy-port=80 \
  --bind-host="0.0.0.0" &> proxy.log &

TOOLCHAIN=<%= context.toolchain %>

modules_to_load=()

case "${TOOLCHAIN}" in
  2022a )
    modules_to_load+=("TensorFlow/2.11.0-foss-2022a")
    ;;
  2023a )
    modules_to_load+=("TensorFlow/2.13.0-foss-2023a")
    # avoid "TypeError: Descriptors cannot not be created directly", causing tensorboard-plugin-wit to be unavailable
    # due to incompatibility with protobuf v4
    # https://github.com/tensorflow/tensorboard/issues/6195
    export PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
    ;;
  * )
    echo "ERROR: Unsupported toolchain selected"
    exit 1
    ;;
esac

module load "${modules_to_load[@]}"

<%- unless context.global_prerun.empty? -%>
<%= context.global_prerun %>
<%- end -%>

tensorboard \
  --port 8080 \
  --logdir "$OOD_WD"
