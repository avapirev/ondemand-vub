#!/usr/bin/bash -l

# rsession.sh doesn't share the same env as the outside script
# so environment variables need to be set explicitly

envfile="<%= session.staged_root %>/env.sh"

# set environment from environment file
source "${envfile}"

ARGS=( "$@" )
CLEAN_WORKSPACE=<%= context.clean_workspace %>

# rserver passess "--r-restore-workspace 2" to rsession, let's update it inplace
if [[ "${CLEAN_WORKSPACE}" == "yes" ]]; then
    ARGS=()
    while [[ $# -gt 0 ]]; do
        if [[ "$1" == "--r-restore-workspace" ]]; then
            # 0 (No), 1 (Yes), or 2 (Default)
            ARGS+=( "--r-restore-workspace" "0" )
            shift 2
        else
            ARGS+=( "$1" )
            shift
        fi
    done
fi

echo "Arguments for R: ${ARGS[@]}"

# Launch the R session
echo "Launching rsession..."
"${EBROOTRSTUDIOMINSERVER}/bin/rsession" \
  --r-libs-user "${R_LIBS_USER}" \
  --session-default-working-dir "$OOD_WD" \
  --session-default-new-project-dir "$OOD_WD" \
  ${ARGS[@]}
